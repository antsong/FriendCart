/**
 * @author Joe Kuan (much improved & ported from ExtJs 3 highchart adapter)
 * @email kuan.joe@gmail.com
 * @version 2.2.3
 * @date 1 Dec 2012
 *
 * Highcharts extension for Sencha Ext JS 4 and Touch 2
 *
 * You are not permitted to remove the author section from this file.
 */
if(!Array.prototype.indexOf)Array.prototype.indexOf=function(a,c){var d=this.length,b=Number(c)||0,b=b<0?Math.ceil(b):Math.floor(b);for(b<0&&(b+=d);b<d;b++)if(b in this&&this[b]===a)return b;return-1};
Ext.define("Chart.ux.Highcharts",{extend:"Ext.Component",alias:["widget.highchart"],statics:{version:"2.2.3"},debug:!1,debugOn:function(){this.debug=!0},sencha:function(){return Ext.versions.extjs?{product:"e",major:Ext.versions.extjs.major,name:"e"+Ext.versions.extjs.major}:Ext.versions.touch?{product:"t",major:Ext.versions.touch.major,name:"t"+Ext.versions.touch.major}:{product:null,major:null,name:null}}(),log:function(a){typeof console!=="undefined"&&this.debug&&console.log(a)},defaultSerieType:null,
resizable:!0,updateDelay:0,loadMask:!1,refreshOnChange:!1,refreshOnLoad:!0,animation:!0,initAnim:!0,updateAnim:!0,lineShift:!1,initAnimAfterLoad:!0,afterChartRendered:null,constructor:function(a){a.listeners&&(this.afterChartRendered=a.listeners.afterChartRendered);this.afterChartRendered&&(this.afterChartRendered=Ext.bind(this.afterChartRendered,this));if(a.animation==!1)this.initAnimAfterLoad=this.updateAnim=this.initAnim=this.animation=!1;this.sencha.product=="t"&&this.on("painted",this.afterRender);
this.callParent(arguments)},initComponent:function(){if(this.store)this.store=Ext.data.StoreManager.lookup(this.store);if(this.animation==!1)this.initAnimAfterLoad=this.updateAnim=this.initAnim=!1;this.callParent(arguments)},addSeries:function(a,c){for(var c=c===null||c===!0?!0:!1,d=this.sencha.product=="t"?this.config:this,b=[],j=[],f,e=0;e<a.length;e++){var k=a[e];k.serieCls?f=k:(k.type!=null||this.defaultSerieType!=null?(f=k.type||this.defaultSerieType,f="highcharts."+f):f="Chart.ux.Highcharts.Serie",
f=Ext.create(f,k));j.push(f.config);b.push(f)}if(this.chart){c?(d.chartConfig.series=d.chartConfig.series?d.chartConfig.series.concat(j):j,d.series=d.series?d.series.concat(b):b):(this.removeAllSeries(),d.series=b,d.chartConfig.series=j);for(e=0;e<j.length;e++)this.chart.addSeries(j[e],!0);this.refresh()}else c?(d.chartConfig.series=d.chartConfig.series?d.chartConfig.series.concat(j):j,d.series=d.series?d.series.concat(b):b):(d.chartConfig.series=j,d.series=b)},removeSerie:function(a,c){var d=this.sencha.product==
"t"?this.config:this,c=c||!0;this.chart&&(this.chart.series[a].remove(c),d.chartConfig.series.splice(a,1));d.series.splice(a,1)},removeAllSeries:function(){for(var a=this.sencha.product=="t"?this.config:this,c=a.series.length,d=0;d<c;d++)this.removeSerie(0);Ext.each(a.chartConfig.xAxis,function(a){delete a.categories})},setTitle:function(a){var c=this.sencha.product=="t"?this.config:this;c.chartConfig.title?c.chartConfig.title.text=a:c.chartConfig.title={text:a};this.chart&&this.chart.container&&
this.draw()},setSubTitle:function(a){var c=this.sencha.product=="t"?this.config:this;c.chartConfig.subtitle?c.chartConfig.subtitle.text=a:c.chartConfig.subtitle={text:a};this.chart&&this.chart.container&&this.draw()},initEvents:function(){if(this.loadMask)this.loadMask=new Ext.LoadMask(this.el,Ext.apply({store:this.store},this.loadMask))},afterRender:function(){var a=this.sencha.product=="t"?this.config:this;this.store&&this.bindStore(this.store,!0);this.bindComponent(!0);Ext.apply(a.chartConfig.chart,
{renderTo:this.sencha.product=="t"?this.element.dom:this.el.dom});Ext.applyIf(a.chartConfig,{xAxis:[{}]});a.xField&&this.store&&this.updatexAxisData();a.series?this.addSeries(a.series,!1):a.series=[];this.initEvents();this.update(0)},onMove:function(){},buildInitData:function(){var a=this.sencha.product=="t"?this.config:this;if(this.store&&!this.store.isLoading()&&a.chartConfig&&!(this.initAnim===!1||a.chartConfig.chart.animation===!1)){var c=[],d=a.series.length,b,j=this.store.data.items;a.chartConfig.series===
void 0&&(a.chartConfig.series=[]);for(b=0;b<d;b++){a.chartConfig.series[b]?a.chartConfig.series[b].data=[]:a.chartConfig.series[b]={data:[]};var f=a.series[b].type||a.chartConfig.chart.type||a.chartConfig.chart.defaultSeriesType||"line",c=a.chartConfig.series[b].data=a.chartConfig.series[b].data||{};switch(f){case "line":case "spline":case "area":case "areaspline":case "scatter":case "bar":case "column":var e=a.series[b].yField||a.series[b].dataIndex,k=a.series[b].colorField;if(a.series[b].xField)for(var g=
a.series[b].xField,f=0;f<j.length;f++){var i=j[f],h=null;k&&(h=a.series[b].resolveColor(k,i,f));h?c.push({x:i.data[g],y:i.data[e],color:h}):c.push([i.data[g],i.data[e]])}else if(a.series[b].yField||a.series[b].dataIndex){for(f=0;f<j.length;f++)i=j[f],h=null,k&&(h=a.series[b].resolveColor(k,i,f)),h?c.push({y:i.data[e],color:h}):c.push(i.data[e]);c=Ext.isArray(a.chartConfig.xAxis)?a.chartConfig.xAxis[0]:a.chartConfig.xAxis;if(a.xField&&(!c.categories||c.categories.length<j.length)){c.categories=c.categories||
[];for(f=0;f<j.length;f++)c.categories.push(j[f].data[a.xField])}}break;case "pie":g=a.series[b].categorieField;e=a.series[b].dataField;k=a.series[b].colorField;if(a.series[b].totalDataField){h={};for(f=0;f<j.length;f++){var i=j[f],l=i.data[g];h[l]=h[l]||{total:0};h[l].total+=i.data[e];k&&(h[l].color=i.data[k])}for(var m in h)l={name:m,y:h[m].total},h[m].color&&(l.color=h[m].color),c.push(l)}else for(f=0;f<j.length;f++)i=j[f],l={name:i.data[g],y:i.data[e]},k&&(l.color=i.data[k]),c.push(l);break;case "columnrange":case "arearange":case "areasplinerange":g=
a.series[b].xField;if(Ext.isArray(a.series[b].dataIndex)){k=a.series[b].dataIndex[0];e=a.series[b].dataIndex[1];for(f=0;f<j.length;f++)i=j[f],h=i.data[k],l=i.data[e],g?h>l?c.push([i.data[g],l,h]):c.push([i.data[g],h,l]):h>l?c.push([l,h]):c.push([h,l])}else if(a.series[b].minDataIndex&&a.series[b].maxDataIndex){k=a.series[b].minDataIndex;e=a.series[b].maxDataIndex;for(f=0;f<j.length;f++)i=j[f],h=i.data[k],l=i.data[e],g?c.push([i.data[g],h,l]):c.push([h,l])}c=Ext.isArray(a.chartConfig.xAxis)?a.chartConfig.xAxis[0]:
a.chartConfig.xAxis;if(a.xField&&!g&&(!c.categories||c.categories.length<j.length)){c.categories=c.categories||[];for(f=0;f<j.length;f++)c.categories.push(j[f].data[a.xField])}}}}},draw:function(){var a=this.sencha.product=="t"?this.config:this;this.log("call draw");if(this.chart&&this.rendered){if(this.resizable){for(var c=0;c<a.series.length;c++)a.series[c].visible=this.chart.series[c].visible;this.chart.destroy();delete this.chart;this.buildInitData();this.chart=new Highcharts.Chart(a.chartConfig,
this.afterChartRendered)}}else if(this.rendered)if(this.initAnimAfterLoad){this.log("initAnimAfterLoad is on, defer creating chart");return}else this.buildInitData(),this.chart=new Highcharts.Chart(a.chartConfig,this.afterChartRendered),this.log("initAnimAfterLoad is off, creating chart from fresh");for(c=0;c<a.series.length;c++)a.series[c].visible||this.chart.series[c].hide();this.store.isLoading()||(this.log("Call refresh from draw"),this.refresh())},onContainerResize:function(){this.draw()},updatexAxisData:function(){var a=
this.sencha.product=="t"?this.config:this,c=[],d=this.store.data.items;if(a.xField&&this.store){for(var b=0;b<d.length;b++)c.push(d[b].data[a.xField]);this.chart?this.chart.xAxis[0].setCategories(c,!0):Ext.isArray(a.chartConfig.xAxis)?a.chartConfig.xAxis[0].categories=c:a.chartConfig.xAxis.categories=c}},bindComponent:function(a){var c=function(a){return a.ownerCt?c(a.ownerCt):a},d=c(this);if(a){if(d.on("move",this.onMove,this),d.on("resize",this.onResize,this),this.ownerCt)this.ownerCt.on("render",
this.update,this)}else this.ownerCt&&this.ownerCt.un("render",this.update,this),d.un("move",this.onMove,this)},bindStore:function(a,c){!c&&this.store&&(a!==this.store&&this.store.autoDestroy?this.store.destroy():(this.store.un("datachanged",this.onDataChange,this),this.store.un("load",this.onLoad,this),this.store.un("add",this.onAdd,this),this.store.un("remove",this.onRemove,this),this.store.un("update",this.onUpdate,this),this.store.un("clear",this.onClear,this)));a&&(a=Ext.StoreMgr.lookup(a),a.on({scope:this,
load:this.onLoad,datachanged:this.onDataChange,add:this.onAdd,remove:this.onRemove,update:this.onUpdate,clear:this.onClear}));(this.store=a)&&!c&&this.refresh()},refresh:function(){var a=this.sencha.product=="t"?this.config:this;this.log("Call refresh ");if(this.store&&this.chart){var c=[],d=a.series.length,b;for(b=0;b<d;b++)c.push([]);for(var j=this.store.data.items,f=[],e=0;e<j.length;e++){var k=j[e];a.xField&&f.push(k.data[a.xField]);for(b=0;b<d;b++){var g=a.series[b];g.dataIndex||g.yField||g.minDataIndex||
g.config.getData?(g=g.getData(k,e),c[b].push(g)):g.type=="pie"?g.useTotals?(e==0&&g.clear(),g.getData(k,e)):g.totalDataField?g.getData(k,c[b]):(g=g.getData(k,e),c[b].push(g)):g.type=="gauge"?c[b][0]=g.getData(k,e):g.data&&g.data.length&&(g.data[e]!==void 0?c[b].push(g.data[e]):c[b].push(null))}}if(this.updateAnim){k=-1;this.log("Update animation with line shift: "+a.lineShift);for(b=0;b<d;b++)if(a.series[b].useTotals)this.chart.series[b].setData(a.series[b].getTotals());else if(c[b].length>0)if(a.lineShift){var i=
Ext.isArray(this.chart.xAxis)?this.chart.xAxis[0]:this.chart.xAxis,h=-1;if(i.categories){if(b==0){for(e=0;e<f.length;e++){for(var l=!1,g=0;g<i.categories.length;g++)if(f[e]==i.categories[g]){l=!0;break}if(!l){k=h=e;break}}g=i.categories.slice(0);g.push(f[e]);i.setCategories(g,!1)}else h=k;this.log("startIdx "+h);if(h!==-1&&h<f.length)for(e=h;e<f.length;e++)this.chart.series[b].addPoint(c[b][e],!1,!0,!0)}else{i=this.chart.series[b].points;for(e=0;e<c[b].length;e++){l=!1;for(g=0;g<i.length;g++)if(c[b][e][0]==
i[g].x){l=!0;break}if(!l){h=e;break}}this.log("startIdx "+h);if(h!==-1&&h<c[b].length)for(e=h;e<c[b].length;e++)this.chart.series[b].addPoint(c[b][e],!1,!0,!0)}}else{h=this.chart.series[b].points.length;i=j.length;for(e=0;e<Math.min(h,i);e++)this.chart.series[b].points[e].update(c[b][e],!1,!0);if(a.series[b].type!="pie")if(this.log("chartSeriesLength "+h+", storeSeriesLength "+i),h<i)for(g=0;g<i-h;g++,e++)Ext.isNumeric(c[b][e])?this.chart.series[b].addPoint([e,c[b][e]],!1,!1,!0):this.chart.series[b].addPoint(c[b][e],
!1,!1,!0);else if(h>i)for(g=0;g<h-i;g++)e=h-g-1,this.log("Remove point at pos "+e),this.chart.series[b].points[e].remove(!1,!0)}a.xField&&!a.lineShift&&this.chart.xAxis[0].setCategories(f,!1);this.chart.redraw()}else{for(b=0;b<d;b++)a.series[b].useTotals?this.chart.series[b].setData(a.series[b].getTotals()):c[b].length>0&&this.chart.series[b].setData(c[b],b==d-1);a.xField&&this.chart.xAxis[0].setCategories(f,!0)}}},refreshRow:function(a){var c=this.sencha.product=="t"?this.config:this,d=this.store.indexOf(a);
if(this.chart){for(var b=0;b<this.chart.series.length;b++){var j=this.chart.series[b],f=c.series[b].getData(a,d);c.series[b].type=="pie"&&c.series[b].useTotals?(c.series[b].update(a),this.chart.series[b].setData(c.series[b].getTotals())):j.data[d].update(f)}c.xField&&this.updatexAxisData()}},update:function(a){a=a||this.updateDelay;if(!this.updateTask)this.updateTask=new Ext.util.DelayedTask(this.draw,this);this.updateTask.delay(a)},onDataChange:function(){this.refreshOnChange&&this.refresh()&&this.log("onDataChange")},
onClear:function(){this.sencha.product=="t"&&this.store&&!this.store.isLoading()&&this.refresh()},onUpdate:function(a,c){this.refreshRow(c)},onAdd:function(a,c,d){for(var a=this.sencha.product=="t"?this.config:this,b=!1,j=[],f=0;f<c.length;f++){var e=c[f];f==c.length-1&&(b=!0);a.xField&&j.push(e.data[a.xField]);for(var k=0;k<this.chart.series.length;k++){var g=this.chart.series[k],i=a.series[k],h=i.getData(e,d+f);i.type=="pie"&&i.useTotals||g.addPoint(h,b)}}a.xField&&this.chart.xAxis[0].setCategories(j,
!0)},onResize:function(){this.callParent(arguments);this.update()},onRemove:function(a,c,d){for(var a=this.sencha.product=="t"?this.config:this,b=0;b<a.series.length;b++){var j=a.series[b];j.type=="pie"&&j.useTotals?(j.removeData(c,d),this.chart.series[b].setData(j.getTotals())):this.chart.series[b].data[d].remove(!0)}Ext.each(this.chart.series,function(a){a.data[d].remove(!0)});a.xField&&this.updatexAxisData()},onLoad:function(){var a=this.sencha.product=="t"?this.config:this;!this.chart&&this.initAnimAfterLoad?
(this.log("Call refresh from onLoad for initAnim"),this.buildInitData(),this.chart=new Highcharts.Chart(a.chartConfig,this.afterChartRendered)):(this.log("Call refresh from onLoad"),this.refreshOnLoad&&this.refresh())},destroy:function(){delete (this.sencha.product=="t"?this.config:this).series;this.chart&&(this.chart.destroy(),delete this.chart);this.bindStore(null);this.bindComponent(null);this.callParent(arguments)}});
Ext.define("Chart.ux.Highcharts.Serie",{type:null,pointObject:!1,xField:null,yField:null,colorField:null,visible:!0,clear:Ext.emptyFn,resolveColor:function(a,c,d){var b=null;a&&(a==="auto"?b=Highcharts.getOptions().colors[d]||Highcharts.getOptions().colors[0]:Ext.isNumeric(a)?b=a:Ext.isString(a)&&(b=/^(#)?([0-9a-fA-F]{3})([0-9a-fA-F]{3})?$/.test(a)?a:c.data[a]));console.log("resolveColor "+a+", "+b);return b},obj_getData:function(a,c){var d={data:a.data,y:a.data[this.yField||this.dataIndex]};this.xField&&
(d.x=a.data[this.xField]);this.colorField&&(d.color=this.resolveColor(this.colorField,a,c));return d},arr_getDataSingle:function(a){return a.data[this.yField]},arr_getDataPair:function(a){return[a.data[this.xField],a.data[this.yField]]},serieCls:!0,constructor:function(a){a.type=this.type;if(!a.data)a.data=[];Ext.apply(this,a);this.config=a;this.yField=this.yField||this.dataIndex;this.colorField&&(this.pointObject=!0);if(!this.getData)this.getData=this.pointObject?this.obj_getData:this.xField?this.arr_getDataPair:
this.arr_getDataSingle}});
Ext.define("Chart.ux.Highcharts.RangeSerie",{extend:"Chart.ux.Highcharts.Serie",minDataIndex:null,maxDataIndex:null,needSorting:null,constructor:function(a){if(Ext.isArray(a.dataIndex))this.field1=a.dataIndex[0],this.field2=a.dataIndex[1],this.needSorting=!0;else if(a.minDataIndex&&a.maxDataIndex)this.minDataIndex=a.minDataIndex,this.maxDataIndex=a.maxDataIndex,this.needSorting=!1;this.callParent(arguments)},getData:function(a){if(this.needSorting===!0)return a.data[this.field1]>a.data[this.field2]?
[a.data[this.field2],a.data[this.field1]]:[a.data[this.field1],a.data[this.field2]];if(a.data[this.minDataIndex]!==void 0&&a.data[this.maxDataIndex]!==void 0)return[a.data[this.minDataIndex],a.data[this.maxDataIndex]]}});Ext.define("Chart.ux.Highcharts.SplineSerie",{extend:"Chart.ux.Highcharts.Serie",alternateClassName:["highcharts.spline"],type:"spline"});Ext.define("Chart.ux.Highcharts.ColumnSerie",{extend:"Chart.ux.Highcharts.Serie",alternateClassName:["highcharts.column"],type:"column"});
Ext.define("Chart.ux.Highcharts.BarSerie",{extend:"Chart.ux.Highcharts.Serie",alternateClassName:["highcharts.bar"],type:"bar"});Ext.define("Chart.ux.Highcharts.LineSerie",{extend:"Chart.ux.Highcharts.Serie",alternateClassName:["highcharts.line"],type:"line"});Ext.define("Chart.ux.Highcharts.AreaSerie",{extend:"Chart.ux.Highcharts.Serie",alternateClassName:["highcharts.area"],type:"area"});
Ext.define("Chart.ux.Highcharts.AreaSplineSerie",{extend:"Chart.ux.Highcharts.Serie",alternateClassName:["highcharts.areaspline"],type:"areaspline"});Ext.define("Chart.ux.Highcharts.GaugeSerie",{extend:"Chart.ux.Highcharts.Serie",alternateClassName:["highcharts.gauge"],type:"gauge"});Ext.define("Chart.ux.Highcharts.AreaRangeSerie",{extend:"Chart.ux.Highcharts.RangeSerie",alternateClassName:["highcharts.arearange"],type:"arearange"});
Ext.define("Chart.ux.Highcharts.AreaSplineRangeSerie",{extend:"Chart.ux.Highcharts.RangeSerie",alternateClassName:["highcharts.areasplinerange"],type:"areasplinerange"});Ext.define("Chart.ux.Highcharts.ColumnRangeSerie",{extend:"Chart.ux.Highcharts.RangeSerie",alternateClassName:["highcharts.columnrange"],type:"columnrange"});Ext.define("Chart.ux.Highcharts.ScatterSerie",{extend:"Chart.ux.Highcharts.Serie",alternateClassName:["highcharts.scatter"],type:"scatter"});
Ext.define("Chart.ux.Highcharts.PieSerie",{extend:"Chart.ux.Highcharts.Serie",alternateClassName:["highcharts.pie"],type:"pie",categorieField:null,totalDataField:!1,dataField:null,useTotals:!1,columns:[],constructor:function(a){this.callParent(arguments);if(this.useTotals){this.columnData={};for(var c=this.columns.length,d=0;d<c;d++)this.columnData[this.columns[d]]=100/c}},addData:function(a){for(var c=0;c<this.columns.length;c++){var d=this.columns[c];this.columnData[d]+=a.data[d]}},update:function(a){for(var c=
0;c<this.columns.length;c++){var d=this.columns[c];a.modified[d]&&(this.columnData[d]=this.columnData[d]+a.data[d]-a.modified[d])}},removeData:function(a){for(var c=0;c<this.columns.length;c++){var d=this.columns[c];this.columnData[d]-=a.data[d]}},clear:function(){for(var a=0;a<this.columns.length;a++)this.columnData[this.columns[a]]=0},getData:function(a,c){if(this.totalDataField){for(var d=null,b=0;b<c.length;b++)if(c[b].name==a.data[this.categorieField]){d=b;c[b].y+=a.data[this.dataField];break}d===
null&&(this.colorField&&a.data[this.colorField]?c.push({name:a.data[this.categorieField],y:a.data[this.dataField],color:a.data[this.colorField]}):c.push({name:a.data[this.categorieField],y:a.data[this.dataField]}),b=c.length-1);return c[b]}return this.useTotals?(this.addData(a),[]):this.colorField&&a.data[this.colorField]?{name:a.data[this.categorieField],y:a.data[this.dataField],color:a.data[this.colorField]}:{name:a.data[this.categorieField],y:a.data[this.dataField]}},getTotals:function(){for(var a=
[],c=0;c<this.columns.length;c++){var d=this.columns[c];a.push([d,this.columnData[d]])}return a}});
